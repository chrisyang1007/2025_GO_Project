<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GO GO Chatroom</title>
<style>
/* (æ˜Ÿç©ºèƒŒæ™¯ CSS) */
html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #e0f7fa; }
body { 
  display: flex; justify-content: center; align-items: center; 
  background-color: #0a0a1a;
}
canvas#galaxy { position: fixed; top: 0; left: 0; z-index: -1; }
.container { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 24px; box-shadow: 0 0 20px rgba(255,255,255,0.1); width: 92%; max-width: 1280px; color: #fff; z-index: 1; }
h2, h3 { margin: 8px 0 12px; }
input, button, textarea, label.button { font-size: 1em; padding: 10px 12px; margin: 6px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: #fff; }
button:hover, label.button:hover { background: rgba(255,255,255,0.25); cursor: pointer; }
.modal input[type="text"] { width: 95%; } /* âœ¨ (åŠŸèƒ½ 1) Modal input å¯¬åº¦ */

/* ... (å…¶ä»– CSS èˆ‡ Response 11 ç›¸åŒ) ... */
.row { display: flex; align-items: center; }
.col { display: flex; flex-direction: column; }
#chat-window { display: none; height: 70vh; }
#chat-content { display: flex; height: 100%; }
#sidebar { width: 200px; padding-right: 20px; border-right: 1px solid rgba(255,255,255,0.2); overflow-y: auto; }
#room-list { list-style: none; padding: 0; }
#room-list li { padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; }
#room-list li:hover { background: rgba(255,255,255,0.1); }
#room-list li.active { background: rgba(135, 206, 250, 0.4); }
#main-chat { flex-grow: 1; display: flex; flex-direction: column; padding-left: 20px; }
#messages { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
.message { display: flex; margin-bottom: 12px; align-items: flex-start; }
.msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
.msg-body { max-width: 70%; display: flex; flex-direction: column; position: relative; }
.msg-header { font-size: 0.9em; font-weight: bold; margin-bottom: 4px; opacity: 0.8; }
.msg-content { padding: 10px 14px; background: rgba(0, 0, 0, 0.2); border-radius: 0 12px 12px 12px; line-height: 1.5; word-wrap: break-word; }
.message.system .msg-body { max-width: 100%; align-items: center; }
.message.system .msg-content { background: rgba(135, 206, 250, 0.2); border-radius: 8px; font-style: italic; }
#chat-controls { display: flex; margin-top: 10px; }
#chat-controls input { flex-grow: 1; }
#chat-controls button { background: rgba(135, 206, 250, 0.3); }
#chat-controls button:hover { background: rgba(135, 206, 250, 0.5); }
#login-window { text-align: center; }
#avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px; justify-items: center; }
.avatar-select { width: 50px; height: 50px; line-height: 50px; font-size: 28px; text-align: center; border-radius: 50%; cursor: pointer; opacity: 0.6; transition: all 0.2s; }
.avatar-select:hover { opacity: 1; transform: scale(1.1); }
.avatar-select.selected { opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px 2px #87CEFA; }
.toolbar { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
.toolbar button, .toolbar label { margin: 4px; padding: 8px 10px; font-size: 0.9em; display: flex; align-items: center; }
#imageInput { display: none; }
#voiceInput { display: none; }
#rec-status { width: 12px; height: 12px; background: #666; border-radius: 50%; margin-left: 8px; }
#rec-status.rec { background: red; animation: pulse 1s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0, 0); } }
.msg-vote { padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.1); }
.vote-option { display: block; margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; }
.vote-option:hover { background: rgba(255,255,255,0.2); }
.vote-result { margin-top: 10px; font-size: 0.9em; }
.msg-quiz { padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.5); }
.msg-quiz.answered { background: rgba(0, 255, 0, 0.1); border-color: rgba(0, 255, 0, 0.5); }
.quiz-input { display: flex; margin-top: 8px; }
.quiz-input input { flex-grow: 1; }
.quiz-input button { background: rgba(255, 215, 0, 0.3); }
.reaction-float { position: absolute; font-size: 2em; animation: floatUp 1.4s ease-out; opacity: 0; }
@keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(1.5); opacity: 0; } }
.msg-reactions { margin-top: 5px; }
.msg-reactions button { font-size: 0.8em; padding: 2px 6px; margin: 2px; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; color: #fff; cursor: pointer; }
.msg-reactions button:hover { background: rgba(255, 255, 255, 0.4); }
.msg-emoji-picker { display: none; position: absolute; top: -20px; right: 10px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); border-radius: 15px; padding: 2px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.message:hover .msg-emoji-picker { display: block; }
.msg-emoji-picker button { font-size: 1.1em; padding: 0 4px; margin: 0; background: none; border: none; color: #fff; cursor: pointer; transition: transform 0.1s; }
.msg-emoji-picker button:hover { transform: scale(1.3); }
#online-status {
  text-align: center; font-weight: bold; margin: 15px 0 10px 0; padding: 10px;
  background: rgba(0, 255, 127, 0.1); border-radius: 8px;
  border: 1px solid rgba(0, 255, 127, 0.3); font-size: 0.9em;
}
#login-window h2 { font-size: 2.2em; font-weight: 300; letter-spacing: 1px; margin-bottom: 5px; }
#login-window p { font-size: 1.1em; opacity: 0.8; margin-bottom: 20px; }
#avatar-grid { max-width: 400px; margin: 20px auto; }
.avatar-select { width: 60px; height: 60px; line-height: 60px; font-size: 32px; }
#login-window #avatar-preview { width: 80px; height: 80px; margin-bottom: 15px; }
#login-window input[type="text"] { width: 250px; text-align: center; font-size: 1.1em; }
#login-window button { font-size: 1.1em; background: rgba(135, 206, 250, 0.4); font-weight: bold; color: #fff;}
#login-window button:hover { background: rgba(135, 206, 250, 0.6); }
.attachment-preview {
  display: none; align-items: center; margin: 0 10px; 
  background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px;
}
.attachment-preview button {
  background:none; border:none; color:red; font-size: 1.5em; 
  padding: 0 5px; cursor: pointer; margin: 0;
}

/* âœ¨ (åŠŸèƒ½ 1) Modal CSS */
.modal-backdrop {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(5px);
  z-index: 10;
}
.modal {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(30, 30, 50, 0.8);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  z-index: 11;
}
.modal h4 { margin-top: 0; font-size: 1.4em; }
.modal-close-btn {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 1.5em;
  color: #fff;
  background: none;
  border: none;
  cursor: pointer;
}
.modal label {
  display: block;
  margin-top: 10px;
  margin-bottom: 5px;
  font-weight: bold;
}
</style>
</head>
<body>

<canvas id="galaxy"></canvas>

<div class="container" id="login-window">
  <h2>GO GO GO èŠå¤©å®¤</h2>
  <p>è«‹é¸æ“‡ä½ çš„é ­åƒå’Œæš±ç¨±</p>
  <div id="avatar-grid"></div>
  <div style="margin: 10px 0;">
    <img id="avatar-preview" src="" style="width: 80px; height: 80px; border-radius: 50%; display: none; margin: 0 auto 15px; border: 2px solid #87CEFA; object-fit: cover;">
    <label for="avatarUpload" class="button" style="cursor: pointer; padding: 10px 12px; display: inline-block;">
      ğŸ–¼ï¸ ä¸Šå‚³è‡ªè¨‚é ­è²¼
    </label>
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
  </div>
  <div class="row" style="justify-content: center;">
    <input type="text" id="nicknameInput" placeholder="è¼¸å…¥æš±ç¨±...">
    <button onclick="login()">ğŸš€ é€²å…¥</button>
  </div>
</div>

<div class="container" id="chat-window">
  <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
    <h3>ğŸ’¬ èŠå¤©å®¤</h3>
    <div>
      <button onclick="goToGame('game.html')">ğŸ® çŒœæ•¸å­—</button>
      <button onclick="goToGame('draw.html')">ğŸ¨ ä½ ç•«æˆ‘çŒœ</button>
    </div>
  </div>
  <div id="chat-content">
    <div id="sidebar">
      <div id="online-status">ğŸŸ¢ åœ¨ç·šï¼š<span id="online-count">0</span> äºº</div>
      <button onclick="logout()" style="width:100%; margin-bottom:15px;">ç™»å‡º</button>
      <h3>æˆ¿é–“åˆ—è¡¨</h3>
      <ul id="room-list"></ul>
      <div class="col">
        <input type="text" id="newRoomInput" placeholder="æˆ¿é–“åç¨±...">
        <input type="password" id="newRoomPassword" placeholder="å¯†ç¢¼ (å¯é¸)...">
        <button onclick="createRoom()">+ å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“</button>
      </div>
    </div>
    <div id="main-chat">
      <h3 id="room-name-header" style="margin: 0 0 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2);">lobby</h3>
      <ul id="messages"></ul>
      <div class="toolbar">
        <label for="imageInput" class="button" id="image-label">ğŸ–¼ï¸ åœ–ç‰‡</label>
        <input type="file" id="imageInput" accept="image/*">
        <label for="voiceInput" class="button" id="voiceBtn">ğŸ¤ èªéŸ³ (æŒ‰ä½)</label>
        <input type="checkbox" id="voiceInput">
        <span id="rec-status"></span>
        <button onclick="showQuizModal()">ğŸ§  å‡ºé¡Œæ¶ç­”</button>
        <button onclick="showVoteModal()">ğŸ“Š ç™¼èµ·æŠ•ç¥¨</button>
      </div>
      <div class="row" id="chat-controls">
        <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
        <div id="image-preview-container" class="attachment-preview">
          <img id="image-preview" src="" style="max-height: 40px; border-radius: 4px;">
          <button id="cancel-image">&times;</button>
        </div>
        <div id="audio-preview-container" class="attachment-preview">
          <span>ğŸ¤ èªéŸ³å·²é™„åŠ </span>
          <button id="cancel-audio">&times;</button>
        </div>
        <button onclick="sendMsg()">ğŸš€ é€å‡º</button>
      </div>
    </div>
  </div>
</div>

<div id="modal-backdrop" onclick="closeModals()"></div>

<div id="quiz-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>ğŸ§  å»ºç«‹æ¶ç­”</h4>
  <label for="quiz-question">é¡Œç›®ï¼š</label>
  <input type="text" id="quiz-question" placeholder="ä¾‹å¦‚ï¼šä»€éº¼æ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„å‹•ç‰©ï¼Ÿ">
  <label for="quiz-answer">ç­”æ¡ˆï¼š</label>
  <input type="text" id="quiz-answer" placeholder="ä¾‹å¦‚ï¼šçµè±¹">
  <button onclick="submitQuiz()" style="margin-top: 15px; width: 100%;">ç™¼é€æ¶ç­”</button>
</div>

<div id="vote-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>ğŸ“Š å»ºç«‹æŠ•ç¥¨</h4>
  <label for="vote-question">å•é¡Œï¼š</label>
  <input type="text" id="vote-question" placeholder="ä¾‹å¦‚ï¼šæ™šé¤è¦åƒä»€éº¼ï¼Ÿ">
  <label for="vote-options">é¸é … (ç”¨é€—è™Ÿ , åˆ†éš”)ï¼š</label>
  <input type="text" id="vote-options" placeholder="ä¾‹å¦‚ï¼šæŠ«è–©, æ¼¢å ¡, ç¾©å¤§åˆ©éºµ">
  <button onclick="submitVote()" style="margin-top: 15px; width: 100%;">ç™¼é€æŠ•ç¥¨</button>
</div>

<script>
// (æ˜Ÿç©º JS èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const canvas = document.getElementById('galaxy');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let stars = [];
for (let i = 0; i < 800; i++) {
  stars.push({ x: Math.random(), y: Math.random(), z: Math.random() });
}
function drawGalaxy() {
  ctx.fillStyle = '#0a0a1a';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2);
  let time = Date.now() * 0.0001;
  stars.forEach(star => {
    let x = (star.x - 0.5) * canvas.width * (2 - star.z) + Math.sin(time + star.z) * 100 * star.z;
    let y = (star.y - 0.5) * canvas.height * (2 - star.z) + Math.cos(time + star.x) * 100 * star.z;
    let r = (1 - star.z) * 1.5;
    let a = (1 - star.z);
    ctx.fillStyle = `rgba(255, 255, 255, ${a})`;
    ctx.beginPath(); ctx.arc(x, y, r, 0, 2 * Math.PI); ctx.fill();
  });
  ctx.restore();
  requestAnimationFrame(drawGalaxy);
}
drawGalaxy();
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };

// (è¼”åŠ©å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function resizeImage(base64Str, maxSize = 96, callback) {
  const img = new Image();
  img.src = base64Str;
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = maxSize;
    canvas.height = maxSize;
    let sourceSize = Math.min(img.width, img.height);
    let sourceX = (img.width - sourceSize) / 2;
    let sourceY = (img.height - sourceSize) / 2;
    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, maxSize, maxSize);
    callback(canvas.toDataURL('image/png'));
  };
}

// (DOM å…ƒç´ èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const loginWindow = document.getElementById('login-window');
const chatWindow = document.getElementById('chat-window');
const nicknameInput = document.getElementById('nicknameInput');
const avatarGrid = document.getElementById('avatar-grid');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const roomListEl = document.getElementById('room-list');
const newRoomInput = document.getElementById('newRoomInput');
const newRoomPassword = document.getElementById('newRoomPassword');
const imageInput = document.getElementById('imageInput');
const voiceInput = document.getElementById('voiceInput');
const voiceBtn = document.getElementById('voiceBtn');
const recStatus = document.getElementById('rec-status');

// âœ¨ (åŠŸèƒ½ 1) Modal DOM
const modalBackdrop = document.getElementById('modal-backdrop');
const quizModal = document.getElementById('quiz-modal');
const voteModal = document.getElementById('vote-modal');

// (ç‹€æ…‹è®Šæ•¸èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
let ws;
let myNickname = '';
let myAvatar = '';
let currentRoom = localStorage.getItem('lastRoom') || 'lobby';
if (localStorage.getItem('lastRoom')) {
  localStorage.removeItem('lastRoom');
}
let roomInfo = {};
let quizAnswer = ''; 
let mediaRecorder;
let audioChunks = [];
let imageToSend = null;
let audioToSend = null; 
let audioTranscript = null;

function goToGame(url) {
  localStorage.setItem('lastRoom', currentRoom);
  location.href = url;
}

function logout() {
  localStorage.removeItem("chatUser");
  localStorage.removeItem("chatAvatar");
  localStorage.removeItem("lastRoom");
  if (ws) {
    ws.onclose = () => {}; // Prevent the default disconnect message
    ws.close();
  }
  location.reload();
}

// (é ­åƒé‚è¼¯èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const avatars = ['ğŸ˜€','ğŸ˜','ğŸš€','ğŸ¤–','ğŸ§ ','ğŸ¨','ğŸ®','ğŸ†','ğŸ’¡','ğŸ“Š'];
avatars.forEach(a => {
  const av = document.createElement('span');
  av.className = 'avatar-select';
  av.textContent = a;
  av.onclick = () => {
    myAvatar = a;
    document.querySelectorAll('.avatar-select').forEach(el => el.classList.remove('selected'));
    av.classList.add('selected');
    avatarPreview.style.display = 'none';
    avatarPreview.src = '';
  };
  avatarGrid.appendChild(av);
});
const avatarUpload = document.getElementById('avatarUpload');
const avatarPreview = document.getElementById('avatar-preview');
avatarUpload.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = re => {
    const fullSizeBase64 = re.target.result;
    resizeImage(fullSizeBase64, 96, (resizedBase64) => {
      myAvatar = resizedBase64;
      avatarPreview.src = myAvatar;
      avatarPreview.style.display = 'block';
      document.querySelectorAll('.avatar-select').forEach(el => el.classList.remove('selected'));
    });
  };
  reader.readAsDataURL(file);
});

// (login å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function login() {
  myNickname = nicknameInput.value.trim();
  if (myNickname && myAvatar) {
    localStorage.setItem("chatUser", myNickname);
    localStorage.setItem("chatAvatar", myAvatar);
    loginWindow.style.display = 'none';
    chatWindow.style.display = 'block';
    initWS();
  } else {
    alert('è«‹è¼¸å…¥æš±ç¨±ä¸¦é¸æ“‡é ­åƒï¼');
  }
}

// âœ¨ (BUG 1) ç§»é™¤éŒ¯èª¤çš„ JS
// (initWS, handleIncoming, sendMsg ç­‰å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function initWS() {
  const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${window.location.host}/ws`);
  ws.onopen = () => {
    console.log('Connected to WS');
    switchRoom(currentRoom, true);
  };
  ws.onmessage = event => {
    const msg = JSON.parse(event.data);
    handleIncoming(msg);
  };
  ws.onclose = () => {
    console.log('Disconnected from WS');
    addSystemMessage('é€£ç·šå·²ä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
  };
  ws.onerror = err => {
    console.error('WS Error:', err);
    addSystemMessage('é€£ç·šç™¼ç”ŸéŒ¯èª¤ã€‚');
  };
}

function handleIncoming(msg) {
  switch (msg.type) {
    case 'online_count':
      document.getElementById('online-count').textContent = msg.content;
      break;
    case 'room_list':
      updateRoomList(msg.roomInfo);
      break;
    case 'password_required':
      const pw = prompt(`æˆ¿é–“ ${msg.room} éœ€è¦å¯†ç¢¼ï¼š`);
      if (pw) {
        switchRoom(msg.room, false, pw);
      }
      break;
    case 'wrong_password':
      alert(`æˆ¿é–“ ${msg.room} çš„å¯†ç¢¼éŒ¯èª¤ï¼`);
      break;
    case 'switch_success':
      currentRoom = msg.room;
      document.getElementById('room-name-header').textContent = currentRoom;
      messagesEl.innerHTML = ''; // Clear messages from old room
      addSystemMessage(`æˆåŠŸåŠ å…¥æˆ¿é–“: ${currentRoom}`);
      document.querySelectorAll('#room-list li').forEach(li => {
        li.classList.toggle('active', li.dataset.room === currentRoom);
      });
      break;
    case 'chat': case 'image': case 'voice':
      renderMessage(msg); break;
    case 'chat': case 'image': case 'voice':
      renderMessage(msg); break;
    case 'join': case 'leave': case 'switch':
      addSystemMessage(msg.content); break;
    case 'vote':
      renderVote(msg); break;
    case 'vote_result':
      updateVoteResults(msg); break;
    case 'quiz_start':
      quizAnswer = msg.answer; renderQuiz(msg); break;
    case 'quiz_answer':
      break;
    case 'quiz_result':
      quizAnswer = ''; updateQuizResult(msg); break;
    case 'reaction': {
      const floatTarget = Array.from(messagesEl.children).find(li => li.dataset.id === msg.content);
      if (floatTarget) {
        const flo = document.createElement('div'); flo.className = 'reaction-float'; flo.textContent = msg.emoji;
        flo.style.left = '60px'; flo.style.top = '10px';
        floatTarget.appendChild(flo); setTimeout(() => flo.remove(), 1400);
      }
      if (!floatTarget) return; 
      const reactionsEl = floatTarget.querySelector('.msg-reactions');
      if (!reactionsEl) return; 
      let countBtn = reactionsEl.querySelector(`[data-emoji="${msg.emoji}"]`);
      if (!countBtn) {
        countBtn = document.createElement('button');
        countBtn.dataset.emoji = msg.emoji;
        countBtn.dataset.count = 1;
        countBtn.textContent = `${msg.emoji} 1`;
        countBtn.onclick = () => { sendReaction(msg.content, msg.emoji); };
        reactionsEl.appendChild(countBtn);
      } else {
        const newCount = parseInt(countBtn.dataset.count) + 1;
        countBtn.dataset.count = newCount;
        countBtn.textContent = `${msg.emoji} ${newCount}`;
      }
      break;
    }
  }
}

function sendMsg() {
  const content = messageInput.value.trim();
  if (imageToSend) {
    ws.send(JSON.stringify({
      type: 'image', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: imageToSend, timestamp: new Date().toISOString()
    }));
    document.getElementById('cancel-image').onclick(); 
  } else if (audioToSend) {
    ws.send(JSON.stringify({
      type: 'voice', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: audioToSend, transcript: content, timestamp: new Date().toISOString()
    }));
    document.getElementById('cancel-audio').onclick();
  } else if (content) {
    ws.send(JSON.stringify({
      type: 'chat', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: content, timestamp: new Date().toISOString()
    }));
    messageInput.value = '';
  }
}
messageInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
});
imageInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('åœ–ç‰‡å¤ªå¤§ï¼è«‹ä¸Šå‚³ 5MB ä»¥ä¸‹çš„åœ–ç‰‡ã€‚'); return; }
  const reader = new FileReader();
  reader.onload = re => {
    imageToSend = re.target.result; 
    document.getElementById('image-preview').src = imageToSend;
    document.getElementById('image-preview-container').style.display = 'flex';
    messageInput.disabled = true; 
    messageInput.placeholder = 'å·²é™„åŠ åœ–ç‰‡';
    voiceBtn.style.display = 'none';
  };
  reader.readAsDataURL(file);
  imageInput.value = null; 
});
document.getElementById('cancel-image').onclick = () => {
  imageToSend = null;
  document.getElementById('image-preview').src = '';
  document.getElementById('image-preview-container').style.display = 'none';
  messageInput.disabled = false;
  messageInput.placeholder = 'è¼¸å…¥è¨Šæ¯...';
  voiceBtn.style.display = 'flex';
};
document.getElementById('cancel-audio').onclick = () => {
  audioToSend = null;
  audioTranscript = null;
  document.getElementById('audio-preview-container').style.display = 'none';
  messageInput.value = '';
  messageInput.placeholder = 'è¼¸å…¥è¨Šæ¯...';
  document.getElementById('image-label').style.display = 'flex';
};
function switchRoom(room, firstTime = false, password = '') {
  if (room === currentRoom && !firstTime) return;
  
  // Don't set currentRoom here, wait for server confirmation
  ws.send(JSON.stringify({
    type: 'switch', room: room, nickname: myNickname,
    avatar: myAvatar, timestamp: new Date().toISOString(),
    password: password
  }));
}
function createRoom() {
  const roomName = newRoomInput.value.trim().toLowerCase().replace(/ /g, '-');
  const password = newRoomPassword.value.trim();
  if (roomName) { 
    switchRoom(roomName, false, password); 
    newRoomInput.value = ''; 
    newRoomPassword.value = '';
  }
}
function joinRoom(room) {
  if (room === currentRoom) return;
  if (roomInfo[room]) {
    const pw = prompt(`æˆ¿é–“ ${room} éœ€è¦å¯†ç¢¼ï¼š`);
    // If user cancels prompt, pw will be null
    if (pw !== null) {
      switchRoom(room, false, pw);
    }
  } else {
    switchRoom(room);
  }
}

function updateRoomList(rooms) {
  roomInfo = rooms;
  roomListEl.innerHTML = '';
  for (const room in rooms) {
    const isPrivate = rooms[room];
    const li = document.createElement('li');
    li.dataset.room = room;
    li.textContent = room + (isPrivate ? ' ğŸ”’' : '');
    li.className = (room === currentRoom) ? 'active' : '';
    li.onclick = () => joinRoom(room);
    roomListEl.appendChild(li);
  }
}
function renderMessage(msg) {
  const li = document.createElement('li');
  li.className = 'message';
  li.dataset.id = msg.timestamp;
  const avatar = document.createElement('img');
  avatar.className = 'msg-avatar';
  if (msg.avatar.startsWith('http') || msg.avatar.startsWith('data:')) {
    avatar.src = msg.avatar;
  } else {
    const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d'); ctx.font = '48px sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(msg.avatar, 32, 36);
    avatar.src = canvas.toDataURL();
  }
  li.appendChild(avatar);
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header';
  header.textContent = msg.nickname; body.appendChild(header);
  const content = document.createElement('div'); content.className = 'msg-content';
  switch (msg.type) {
    case 'chat':
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      content.innerHTML = msg.content.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
      break;
    case 'image':
      const img = document.createElement('img'); img.src = msg.content;
      img.style.maxWidth = '100%'; img.style.maxHeight = '300px'; img.style.borderRadius = '8px';
      img.onload = () => messagesEl.scrollTop = messagesEl.scrollHeight;
      content.appendChild(img);
      break;
    case 'voice': renderVoiceMessage(content, msg); break;
  }
  body.appendChild(content);
  const emojiPicker = document.createElement('div'); emojiPicker.className = 'msg-emoji-picker';
  const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢'];
  emojis.forEach(emoji => {
    const btn = document.createElement('button'); btn.textContent = emoji;
    btn.onclick = () => sendReaction(msg.timestamp, emoji);
    emojiPicker.appendChild(btn);
  });
  body.appendChild(emojiPicker);
  const reactionsEl = document.createElement('div'); reactionsEl.className = 'msg-reactions';
  body.appendChild(reactionsEl);
  li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function renderVoiceMessage(content, msg) {
  const audio = new Audio(msg.content);
  const bar = document.createElement('div');
  bar.style.display = 'flex'; bar.style.alignItems = 'center';
  const playBtn = document.createElement('button'); playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
  const duration = document.createElement('span'); duration.textContent = ' 00:00';
  bar.appendChild(playBtn); bar.appendChild(duration);
  audio.onloadedmetadata = () => { duration.textContent = ` ${Math.floor(audio.duration)}s`; };
  playBtn.onclick = () => {
    if (audio.paused) { audio.play(); playBtn.textContent = 'â¸ï¸ æš«åœ'; }
    else { audio.pause(); playBtn.textContent = 'â–¶ï¸ æ’­æ”¾'; }
  };
  audio.onended = () => { playBtn.textContent = 'â–¶ï¸ æ’­æ”¾'; };
  const transcript = document.createElement('i');
  if (msg.transcript) {
    transcript.textContent = `"${msg.transcript}"`;
    transcript.style.display = 'block'; transcript.style.marginTop = '5px';
    transcript.style.opacity = '0.8';
  }
  content.appendChild(bar); 
  if (msg.transcript) content.appendChild(transcript);
}
function addSystemMessage(text) {
  const li = document.createElement('li'); li.className = 'message system';
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content';
  content.textContent = text;
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
if ('MediaRecorder' in window && 'webkitSpeechRecognition' in window) {
  const recognition = new webkitSpeechRecognition();
  recognition.continuous = false; recognition.lang = 'cmn-Hant-TW'; recognition.interimResults = false;
  let finalTranscript = '';
  recognition.onresult = event => { finalTranscript = event.results[0][0].transcript; };
  const startRec = () => {
    if (imageToSend) return;
    audioChunks = [];
    mediaRecorder.start(); recognition.start();
    recStatus.classList.add('rec'); voiceBtn.textContent = '... éŒ„éŸ³ä¸­ ...';
  };
  const stopRec = () => {
    mediaRecorder.stop(); recognition.stop();
    recStatus.classList.remove('rec'); voiceBtn.textContent = 'ğŸ¤ èªéŸ³ (æŒ‰ä½)';
  };
  recognition.onend = () => {
    if (audioChunks.length === 0) {
        finalTranscript = ''; return;
    }
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.onload = () => {
        audioToSend = reader.result;
        audioTranscript = finalTranscript;
        messageInput.value = finalTranscript;
        messageInput.placeholder = 'èªéŸ³è¨Šæ¯å·²é™„åŠ  (å¯ç·¨è¼¯æ–‡å­—)';
        messageInput.focus();
        document.getElementById('audio-preview-container').style.display = 'flex';
        document.getElementById('image-label').style.display = 'none';
    };
    reader.readAsDataURL(audioBlob);
    audioChunks = [];
    finalTranscript = '';
  };
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      voiceInput.onchange = () => { if (voiceInput.checked) startRec(); else stopRec(); };
      voiceBtn.onmousedown = voiceInput.onchange; voiceBtn.onmouseup = voiceInput.onchange;
      voiceBtn.ontouchstart = e => { e.preventDefault(); voiceInput.checked = true; voiceInput.onchange(); };
      voiceBtn.ontouchend = e => { e.preventDefault(); voiceInput.checked = false; voiceInput.onchange(); };
    });
} else {
  voiceBtn.textContent = 'ğŸš« ä¸æ”¯æ´èªéŸ³'; voiceBtn.disabled = true;
}

// âœ¨ (åŠŸèƒ½ 1) Modal JS
function showQuizModal() {
  modalBackdrop.style.display = 'block';
  quizModal.style.display = 'block';
  document.getElementById('quiz-question').focus();
}
function showVoteModal() {
  modalBackdrop.style.display = 'block';
  voteModal.style.display = 'block';
  document.getElementById('vote-question').focus();
}
function closeModals() {
  modalBackdrop.style.display = 'none';
  quizModal.style.display = 'none';
  voteModal.style.display = 'none';
}
function submitQuiz() {
  const question = document.getElementById('quiz-question').value;
  const answer = document.getElementById('quiz-answer').value;
  if (!question || !answer) {
    alert('é¡Œç›®å’Œç­”æ¡ˆéƒ½ä¸èƒ½ç‚ºç©ºï¼'); return;
  }
  ws.send(JSON.stringify({
    type: 'quiz_start', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    question: question, answer: normalize(answer), timestamp: new Date().toISOString()
  }));
  closeModals();
  document.getElementById('quiz-question').value = '';
  document.getElementById('quiz-answer').value = '';
}
function submitVote() {
  const question = document.getElementById('vote-question').value;
  const optionsStr = document.getElementById('vote-options').value;
  if (!question || !optionsStr) {
    alert('å•é¡Œå’Œé¸é …éƒ½ä¸èƒ½ç‚ºç©ºï¼'); return;
  }
  const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
  if (options.length < 2) {
    alert('è‡³å°‘éœ€è¦å…©å€‹é¸é …'); return;
  }
  ws.send(JSON.stringify({
    type: 'vote', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    question: question, options: options, timestamp: new Date().toISOString()
  }));
  closeModals();
  document.getElementById('vote-question').value = '';
  document.getElementById('vote-options').value = '';
}
// (èˆŠçš„æŠ•ç¥¨/æ¶ç­”å‡½å¼ renderVote, sendVote... ç­‰èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function renderVote(msg) {
  const li = document.createElement('li'); li.className = 'message system'; li.dataset.id = msg.timestamp;
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content msg-vote';
  content.innerHTML = `<strong>ğŸ“Š ${msg.nickname} ç™¼èµ·äº†æŠ•ç¥¨ï¼š</strong><br>${msg.question}`;
  const optionsEl = document.createElement('div'); optionsEl.style.marginTop = '10px';
  msg.options.forEach(opt => {
    const optBtn = document.createElement('a'); optBtn.className = 'vote-option';
    optBtn.textContent = opt; optBtn.href = '#';
    optBtn.onclick = e => {
      e.preventDefault(); sendVote(msg.timestamp, opt);
      optionsEl.querySelectorAll('a').forEach(a => { a.style.pointerEvents = 'none'; a.style.opacity = '0.6'; });
      optBtn.style.background = 'rgba(135, 206, 250, 0.4)';
    };
    optionsEl.appendChild(optBtn);
  });
  content.appendChild(optionsEl);
  const resultEl = document.createElement('div'); resultEl.className = 'vote-result';
  content.appendChild(resultEl);
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function sendVote(voteId, option) {
  ws.send(JSON.stringify({ type: 'vote_answer', room: currentRoom, content: voteId, answer: option }));
}
function updateVoteResults(msg) {
  const voteEl = document.querySelector(`li[data-id="${msg.content}"] .msg-vote`);
  if (!voteEl) return;
  const resultEl = voteEl.querySelector('.vote-result');
  resultEl.innerHTML = '<strong>çµæœï¼š</strong><br>';
  for (const [option, count] of Object.entries(msg.results)) {
    resultEl.innerHTML += `${option}: ${count} ç¥¨<br>`;
  }
}
function renderQuiz(msg) {
  const li = document.createElement('li'); li.className = 'message system'; li.dataset.id = msg.timestamp;
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content msg-quiz';
  content.innerHTML = `<strong>ğŸ§  ${msg.nickname} ç™¼èµ·äº†æ¶ç­”ï¼š</strong><br>${msg.question}`;
  const inputEl = document.createElement('div'); inputEl.className = 'quiz-input';
  const answerInput = document.createElement('input'); answerInput.type = 'text';
  answerInput.placeholder = 'è¼¸å…¥ç­”æ¡ˆ...';
  const submitBtn = document.createElement('button'); submitBtn.textContent = 'æ¶ç­”ï¼';
  const sendAnswer = () => {
    const ans = answerInput.value;
    if (ans) { submitQuizAnswer(msg.timestamp, ans); answerInput.disabled = true; submitBtn.disabled = true; }
  };
  submitBtn.onclick = sendAnswer;
  answerInput.onkeydown = e => { if (e.key === 'Enter') sendAnswer(); };
  inputEl.appendChild(answerInput); inputEl.appendChild(submitBtn);
  content.appendChild(inputEl);
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function submitQuizAnswer(quizId, answer) {
  ws.send(JSON.stringify({
    type: 'quiz_answer', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    content: quizId, answer: normalize(answer) 
  }));
}
function updateQuizResult(msg) {
  addSystemMessage(`ğŸ† æ¶ç­”çµæŸï¼ ${msg.nickname} ç­”å°äº†ï¼ç­”æ¡ˆæ˜¯ï¼š${msg.answer}`);
  const quizEl = document.querySelector(`li[data-id="${msg.content}"] .msg-quiz`);
  if (quizEl) {
    quizEl.classList.add('answered');
    const inputEl = quizEl.querySelector('.quiz-input');
    if (inputEl) inputEl.style.display = 'none'; 
  }
}
function sendReaction(messageId, emoji) {
  ws.send(JSON.stringify({
    type: 'reaction', room: currentRoom, content: messageId, emoji: emoji
  }));
}
function normalize(s) {
  return (s || '').trim().toLowerCase()
    .replace(/[ï¼ã€‚ï¼Ÿï¼Œ]/g, m => ({'ï¼':'!','ã€‚':'.','ï¼Ÿ':'?','ï¼Œ':','}[m]));
}

function checkExistingLogin() {
  const storedUser = localStorage.getItem("chatUser");
  const storedAvatar = localStorage.getItem("chatAvatar");
  if (storedUser && storedAvatar) {
    myNickname = storedUser;
    myAvatar = storedAvatar;
    loginWindow.style.display = 'none';
    chatWindow.style.display = 'block';
    initWS();
  }
}
window.onload = checkExistingLogin;

</script>
</body>
</html>