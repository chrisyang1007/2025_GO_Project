<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æ˜Ÿç©ºèŠå¤©å®¤ â€” äº’å‹•å¼·åŒ–ç‰ˆ</title>
<style>
html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #e0f7fa; }
body { display: flex; justify-content: center; align-items: center; }
canvas#galaxy { position: fixed; top: 0; left: 0; z-index: -1; }
.container { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 24px; box-shadow: 0 0 20px rgba(255,255,255,0.1); width: 92%; max-width: 980px; color: #fff; z-index: 1; }
h2, h3 { margin: 8px 0 12px; }
input, button, textarea { font-size: 1em; padding: 10px 12px; margin: 6px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: #fff; }
button:hover { background: rgba(255,255,255,0.25); cursor: pointer; }
.row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
#messages { list-style: none; padding: 10px; margin: 12px 0; height: 320px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.06); }
.message { position: relative; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
.avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex: 0 0 auto; }
.msg-body { flex: 1; }
.msg-header { font-weight: 600; opacity: 0.9; margin-bottom: 4px; }
.msg-content { white-space: pre-wrap; word-break: break-word; }
.msg-media { max-width: 220px; max-height: 180px; border-radius: 8px; display: block; margin-top: 6px; cursor: zoom-in; }
.reaction-bar { display: flex; gap: 6px; margin-top: 6px; opacity: 0.8; }
.reaction-btn { background: rgba(255,255,255,0.12); border-radius: 14px; padding: 4px 8px; font-size: 0.95em; }
.reaction-float { position: absolute; animation: floatUp 1.4s ease-out forwards; pointer-events: none; font-size: 20px; }
@keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-36px); opacity: 0; } }
.bullet { position: fixed; white-space: nowrap; animation: move 10s linear; font-weight: bold; font-size: 1.3em; color: #ffffff; text-shadow: 0 0 5px #00bcd4; }
@keyframes move { from { right: -300px; } to { right: 100%; } }
.tools { display: grid; grid-template-columns: 1fr; gap: 8px; margin: 4px 0 10px; }
.tools .row { gap: 10px; }
.tool-box { border: 1px dashed rgba(0,200,255,0.4); border-radius: 10px; padding: 10px; background: rgba(0,0,0,0.2); }
#dropzone { border: 2px dashed rgba(0,200,255,0.6); border-radius: 12px; padding: 14px; text-align: center; color: #aee; transition: 0.2s; }
#dropzone.dragover { background: rgba(0,200,255,0.08); box-shadow: 0 0 10px rgba(0,200,255,0.4) inset; }
.quiz-info { margin-left: 8px; color: #a8e; font-weight: 600; }
audio { margin-top: 6px; width: 220px; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 2; }
.modal img { max-width: 90vw; max-height: 90vh; border-radius: 10px; }
.footer-row { display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
.small { font-size: 0.9em; opacity: 0.8; }
</style>
</head>
<body>
<canvas id="galaxy"></canvas>

<div class="container">
  <h2>ğŸŒŒ æ˜Ÿç©ºèŠå¤©å®¤</h2>

  <div id="login">
    <div class="row">
      <span>æš±ç¨±ï¼š</span><input id="nickname" placeholder="è¼¸å…¥æš±ç¨±">
      <span>æˆ¿é–“ï¼š</span><input id="room" value="default">
    </div>
    <div class="row">
      <span>é ­è²¼ï¼š</span><input type="file" id="upload" accept="image/*">
      <button onclick="joinChat()">åŠ å…¥èŠå¤©å®¤</button>
      <button onclick="location.href='game.html'">ğŸ® å°éŠæˆ²ï¼šçŒœæ•¸å­—</button>
    </div>
  </div>

  <div id="chat" style="display:none;">
    <h3 id="roomTitle"></h3>

    <!-- å·¥å…·åˆ—ï¼šå³æ™‚æ¶ç­”ã€èªéŸ³ã€åœ–ç‰‡/GIFã€æ‹–æ›³ä¸Šå‚³ -->
    <div class="tools">
      <div class="tool-box">
        <div class="row">
          <strong>å³æ™‚æ¶ç­”</strong>
          <input id="quizQuestion" placeholder="é¡Œç›®ï¼ˆä¾‹å¦‚ï¼š1+1=ï¼Ÿï¼‰">
          <input id="quizAnswer" placeholder="ç­”æ¡ˆï¼ˆä¾‹å¦‚ï¼š2ï¼‰">
          <button onclick="startQuiz()">ç™¼èµ·é¡Œç›®</button>
          <span id="quizStatus" class="quiz-info"></span>
        </div>
        <div class="row">
          <input id="quizMyAnswer" placeholder="ä½ çš„ç­”æ¡ˆ">
          <button onclick="submitQuizAnswer()">æ¶ç­”</button>
        </div>
      </div>

      <div class="tool-box">
        <div class="row">
          <strong>èªéŸ³è¨Šæ¯</strong>
          <button id="recBtn" onclick="toggleRecord()">é–‹å§‹éŒ„éŸ³</button>
          <span id="sttStatus" class="small"></span>
        </div>
      </div>

      <div class="tool-box">
        <div class="row">
          <strong>åœ–ç‰‡ / GIF åˆ†äº«</strong>
          <input type="file" id="imgPicker" accept="image/*" multiple>
          <button onclick="sendPickedImages()">é€å‡ºé¸å–æª”æ¡ˆ</button>
        </div>
        <div id="dropzone">å°‡åœ–ç‰‡æˆ– GIF æ‹–æ›³åˆ°æ­¤è™•ä¸Šå‚³</div>
      </div>
    </div>

    <ul id="messages"></ul>

    <!-- è¼¸å…¥åˆ— + åæ‡‰é è¦½ -->
    <div class="footer-row">
      <div class="row" style="flex: 1 1 420px;">
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯ä¸¦é€å‡ºï¼ˆè¼¸å…¥ 'æµæ˜Ÿ' å¯è§¸ç™¼ç‰¹æ•ˆï¼‰" style="flex:1;">
        <button onclick="sendMessage()">é€å‡º</button>
      </div>
      <div class="row small">æç¤ºï¼šé»æ“Šè¨Šæ¯ä¸‹çš„ ğŸ‘ ğŸ˜‚ â¤ï¸ ğŸš€ å¯ä»¥é€å‡ºè¡¨æƒ…åæ‡‰</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="leaveRoom()">é€€å‡ºæˆ¿é–“</button>
      <input id="newRoom" placeholder="æ–°æˆ¿é–“">
      <button onclick="switchRoom()">åˆ‡æ›æˆ¿é–“</button>
    </div>
  </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§ Modal -->
<div id="imgModal" class="modal" onclick="hideModal()">
  <img id="modalImg" src="">
</div>

<script>
// ===== èƒŒæ™¯ï¼šé»‘è—æ˜Ÿç³» + æµæ˜Ÿ + é–ƒçˆ + é—œéµå­—ç‰¹æ•ˆ =====
const canvas = document.getElementById('galaxy');
const ctx = canvas.getContext('2d');
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;

const stars = [];
const STAR_COUNT = 600;
for (let i = 0; i < STAR_COUNT; i++) {
  stars.push({
    x: Math.random() * width - width / 2,
    y: Math.random() * height - height / 2,
    z: Math.random() * width,
    radius: Math.random() * 1.5 + 0.5,
    baseColor: `hsl(${200 + Math.random() * 40}, 100%, ${70 + Math.random() * 20}%)`,
    brightness: 1
  });
}

let meteors = [];
function spawnMeteor() {
  const startX = Math.random() * width;
  const startY = Math.random() * height * 0.3;
  const length = Math.random() * 80 + 50;
  const speed = Math.random() * 4 + 6;
  meteors.push({ x: startX, y: startY, length, speed, angle: Math.PI/4, opacity: 1 });
}
function spawnSpecialMeteor() {
  const startX = Math.random() * width;
  const startY = Math.random() * height * 0.3;
  const length = Math.random() * 150 + 100;
  const speed = Math.random() * 6 + 10;
  meteors.push({ x: startX, y: startY, length, speed, angle: Math.PI/4, opacity: 1.2 });
}
setInterval(() => { if (meteors.length < 5) spawnMeteor(); }, Math.random()*2500 + 1500);

function drawGalaxy() {
  const g = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, width);
  g.addColorStop(0, 'rgba(10, 20, 40, 0.9)'); g.addColorStop(1, 'rgba(0, 0, 0, 1)');
  ctx.fillStyle = g; ctx.fillRect(0, 0, width, height);

  for (let star of stars) {
    star.z -= 2.5;
    if (star.z <= 0) { star.z = width; star.x = Math.random()*width - width/2; star.y = Math.random()*height - height/2; }
    const k = 128 / star.z, px = star.x * k + width/2, py = star.y * k + height/2;
    if (star.brightness > 1) star.brightness -= 0.02;
    ctx.beginPath(); ctx.arc(px, py, star.radius, 0, Math.PI*2);
    ctx.fillStyle = star.baseColor; ctx.globalAlpha = star.brightness; ctx.shadowBlur = 10; ctx.shadowColor = star.baseColor; ctx.fill(); ctx.globalAlpha = 1;
  }

  for (let i = meteors.length - 1; i >= 0; i--) {
    const m = meteors[i];
    ctx.strokeStyle = `rgba(173,216,255,${m.opacity})`; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(m.x, m.y);
    ctx.lineTo(m.x - m.length * Math.cos(m.angle), m.y - m.length * Math.sin(m.angle));
    ctx.stroke();

    for (let star of stars) {
      const k = 128 / star.z, px = star.x * k + width/2, py = star.y * k + height/2;
      if (Math.hypot(px - m.x, py - m.y) < 100) star.brightness = 2;
    }
    m.x += m.speed * Math.cos(m.angle);
    m.y += m.speed * Math.sin(m.angle);
    m.opacity -= 0.01;
    if (m.opacity <= 0) meteors.splice(i, 1);
  }
  requestAnimationFrame(drawGalaxy);
}
drawGalaxy();
addEventListener('resize', () => { width = canvas.width = innerWidth; height = canvas.height = innerHeight; });

// ===== åŸºæœ¬èŠå¤©å®¤è®Šæ•¸ =====
let ws, nickname, room, avatar, customAvatar = "";
const $ = (id) => document.getElementById(id);
const messagesEl = $('messages');

// ç”¢ç”Ÿç”¨æ–¼è¨Šæ¯é—œè¯çš„ ID
const genId = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

// é ­è²¼ä¸Šå‚³ï¼ˆåªå…è¨±è‡ªè¨‚é ­è²¼ï¼‰
$('upload').addEventListener('change', e => {
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = () => { customAvatar = reader.result; };
  reader.readAsDataURL(f);
});

// ===== åŠ å…¥èŠå¤©å®¤ =====
function joinChat() {
  nickname = $('nickname').value.trim();
  room = $('room').value.trim();
  avatar = customAvatar;
  if (!nickname || !room || !avatar) return alert("è«‹è¼¸å…¥æš±ç¨±ã€æˆ¿é–“ï¼Œä¸¦ä¸Šå‚³é ­è²¼");

  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'join', nickname, room, avatar }));
  };
  ws.onmessage = (ev) => handleIncoming(JSON.parse(ev.data));

  $('login').style.display = 'none';
  $('chat').style.display = 'block';
  $('roomTitle').textContent = `æˆ¿é–“ï¼š${room}`;
}

// ===== ç™¼é€ç´”æ–‡å­—è¨Šæ¯ + å½ˆå¹• + é—œéµå­—ç‰¹æ•ˆï¼ˆç”±æ‰€æœ‰äººæ¥æ”¶å¾Œè§¸ç™¼ï¼‰=====
function sendMessage() {
  const content = $('msg').value.trim();
  if (!content) return;
  const id = genId();
  ws.send(JSON.stringify({ type: 'chat', id, nickname, room, avatar, content }));
  $('msg').value = '';
}

// ===== æŠ•ç¥¨ï¼ˆæ²¿ç”¨ä½ åŸæœ‰çš„æ¦‚å¿µï¼‰=====
function sendVote(option) {
  ws.send(JSON.stringify({ type: 'vote', nickname, room, avatar, content: option }));
}

// ===== é€€å‡º / åˆ‡æ› =====
function leaveRoom() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'leave', nickname, room }));
    ws.close();
  }
  messagesEl.innerHTML = '';
  $('chat').style.display = 'none';
  $('login').style.display = 'block';
}
function switchRoom() {
  const newR = $('newRoom').value.trim(); if (!newR) return;
  ws.send(JSON.stringify({ type: 'switch', nickname, room, content: newR }));
  room = newR; $('roomTitle').textContent = `æˆ¿é–“ï¼š${room}`;
}

// ===== å³æ™‚æ¶ç­” =====
let quizActive = false;
let quizAnswer = '';
function startQuiz() {
  const q = $('quizQuestion').value.trim();
  const a = $('quizAnswer').value.trim();
  if (!q || !a) return alert('è«‹è¼¸å…¥é¡Œç›®èˆ‡ç­”æ¡ˆ');
  ws.send(JSON.stringify({ type: 'quiz_start', nickname, room, question: q, answer: a }));
}
function submitQuizAnswer() {
  const a = $('quizMyAnswer').value.trim();
  if (!quizActive) return alert('ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„é¡Œç›®');
  if (!a) return;
  ws.send(JSON.stringify({ type: 'quiz_answer', nickname, room, answer: a }));
  $('quizMyAnswer').value = '';
}

// ===== è¡¨æƒ…åæ‡‰ï¼ˆå°ç‰¹å®šè¨Šæ¯ï¼‰=====
const REACTIONS = ['ğŸ‘','ğŸ˜‚','â¤ï¸','ğŸš€'];
function sendReaction(messageId, emoji) {
  ws.send(JSON.stringify({ type: 'reaction', nickname, room, messageId, emoji }));
}

// ===== èªéŸ³è¨Šæ¯ + èªéŸ³è½‰æ–‡å­— =====
let mediaRecorder = null, chunks = [], recognizing = false, speechRec = null;
function toggleRecord() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop(); $('recBtn').textContent = 'é–‹å§‹éŒ„éŸ³';
    if (speechRec && recognizing) speechRec.stop();
    return;
  }
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const base64 = await blobToDataURL(blob);
      // è‹¥æœ‰ STT çµæœå°±ä¸€èµ·å¸¶ä¸Š
      ws.send(JSON.stringify({ type: 'voice', nickname, room, avatar, audio: base64, transcript: lastTranscript }));
      lastTranscript = '';
      $('sttStatus').textContent = '';
    };
    mediaRecorder.start();
    $('recBtn').textContent = 'åœæ­¢éŒ„éŸ³';
    tryStartSTT();
  }).catch(() => alert('ç„¡æ³•å–å¾—éº¥å…‹é¢¨'));
}
function blobToDataURL(blob) {
  return new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.readAsDataURL(blob);
  });
}
let lastTranscript = '';
function tryStartSTT() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { $('sttStatus').textContent = 'ï¼ˆè£ç½®ä¸æ”¯æ´èªéŸ³è½‰æ–‡å­—ï¼‰'; return; }
  speechRec = new SR();
  speechRec.lang = 'zh-TW';
  speechRec.interimResults = true;
  recognizing = true;
  speechRec.onresult = e => {
    let text = '';
    for (let i = e.resultIndex; i < e.results.length; i++) text += e.results[i][0].transcript;
    lastTranscript = text;
    $('sttStatus').textContent = 'STTï¼š' + text;
  };
  speechRec.onend = () => recognizing = false;
  try { speechRec.start(); } catch {}
}

// ===== åœ–ç‰‡/GIF ä¸Šå‚³ + æ‹–æ›³ =====
$('imgPicker').addEventListener('change', async (e) => {
  await sendFiles(e.target.files);
  e.target.value = '';
});
$('dropzone').addEventListener('dragover', e => { e.preventDefault(); $('dropzone').classList.add('dragover'); });
$('dropzone').addEventListener('dragleave', () => $('dropzone').classList.remove('dragover'));
$('dropzone').addEventListener('drop', async e => {
  e.preventDefault(); $('dropzone').classList.remove('dragover');
  await sendFiles(e.dataTransfer.files);
});
function sendPickedImages() {
  $('imgPicker').click();
}
async function sendFiles(fileList) {
  const files = Array.from(fileList || []);
  for (const f of files) {
    if (!f.type.startsWith('image/')) continue;
    const dataUrl = await fileToDataURL(f);
    ws.send(JSON.stringify({ type: 'image', nickname, room, avatar, name: f.name, mime: f.type, dataUrl }));
  }
}
function fileToDataURL(file) {
  return new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.readAsDataURL(file);
  });
}

// ===== æ”¶åˆ°è¨Šæ¯çš„ç¸½è™•ç† =====
function handleIncoming(msg) {
  switch (msg.type) {
    case 'chat':
      renderChatMessage(msg);
      if (msg.content && msg.content.includes('æµæ˜Ÿ')) spawnSpecialMeteor();
      break;
    case 'reaction':
      renderReaction(msg.messageId, msg.emoji);
      break;
    case 'image':
      renderImageMessage(msg);
      break;
    case 'voice':
      renderVoiceMessage(msg);
      break;
    case 'quiz_start':
      quizActive = true; quizAnswer = (msg.answer || '').trim();
      $('quizStatus').textContent = `é¡Œç›®ï¼š${msg.question}ï¼ˆæ¶ç­”é–‹å§‹ï¼ï¼‰`;
      addSystemMessage(`ã€æ¶ç­”ã€‘${msg.nickname} ç™¼èµ·é¡Œç›®ï¼š${msg.question}`);
      break;
    case 'quiz_answer':
      // ç¬¬ä¸€å€‹ç­”å°çš„äººå»£æ’­ quiz_resultï¼›ç‚ºç°¡åŒ–ï¼Œä»»ä¸€ç«¯åˆ¤æ–·æ­£ç¢ºå³å»£æ’­ï¼ˆç¤ºç¯„ç”¨ï¼‰
      if (quizActive && normalize(msg.answer) === normalize(quizAnswer)) {
        ws.send(JSON.stringify({ type: 'quiz_result', nickname: msg.nickname, room, correct: true, answer: msg.answer }));
      }
      break;
    case 'quiz_result':
      quizActive = false;
      $('quizStatus').textContent = `ğŸ† å¾—ä¸»ï¼š${msg.nickname}ï¼Œç­”æ¡ˆï¼š${msg.answer}`;
      addSystemMessage(`ğŸ† ã€æ¶ç­”çµæœã€‘${msg.nickname} ç‡å…ˆç­”å°ï¼ç­”æ¡ˆï¼š${msg.answer}`);
      break;
    default:
      // å…¶ä»–è‡ªå®šå‹åˆ¥...
      break;
  }
}

// ===== UI æ¸²æŸ“ =====
function renderChatMessage(msg) {
  const li = document.createElement('li'); li.className = 'message'; li.dataset.id = msg.id || genId();
  const img = document.createElement('img'); img.className = 'avatar'; img.src = msg.avatar || ''; li.appendChild(img);
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header'; header.textContent = `[${msg.nickname}]`;
  const content = document.createElement('div'); content.className = 'msg-content'; content.textContent = msg.content || '';
  const bar = document.createElement('div'); bar.className = 'reaction-bar';
  REACTIONS.forEach(em => {
    const b = document.createElement('button'); b.className = 'reaction-btn'; b.textContent = em;
    b.onclick = () => sendReaction(li.dataset.id, em);
    bar.appendChild(b);
  });
  body.appendChild(header); body.appendChild(content); body.appendChild(bar);
  li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // å½ˆå¹•
  if (msg.content && msg.content.trim() !== '') {
    const bullet = document.createElement('div'); bullet.className = 'bullet';
    bullet.style.top = Math.random() * 80 + '%'; bullet.textContent = msg.content;
    document.body.appendChild(bullet); setTimeout(() => bullet.remove(), 10000);
  }
}

function renderImageMessage(msg) {
  const li = document.createElement('li'); li.className = 'message'; li.dataset.id = msg.id || genId();
  const imgA = document.createElement('img'); imgA.className = 'avatar'; imgA.src = msg.avatar || ''; li.appendChild(imgA);
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header'; header.textContent = `[${msg.nickname}] åˆ†äº«äº†åœ–ç‰‡ ${msg.name || ''}`;
  const media = document.createElement('img'); media.className = 'msg-media'; media.src = msg.dataUrl; media.alt = msg.name || 'image';
  media.onclick = () => showModal(media.src);
  const bar = document.createElement('div'); bar.className = 'reaction-bar';
  REACTIONS.forEach(em => {
    const b = document.createElement('button'); b.className = 'reaction-btn'; b.textContent = em;
    b.onclick = () => sendReaction(li.dataset.id, em);
    bar.appendChild(b);
  });
  body.appendChild(header); body.appendChild(media); body.appendChild(bar);
  li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function renderVoiceMessage(msg) {
  const li = document.createElement('li'); li.className = 'message'; li.dataset.id = msg.id || genId();
  const imgA = document.createElement('img'); imgA.className = 'avatar'; imgA.src = msg.avatar || ''; li.appendChild(imgA);
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header'; header.textContent = `[${msg.nickname}] èªéŸ³è¨Šæ¯`;
  const audio = document.createElement('audio'); audio.controls = true; audio.src = msg.audio;
  const transcript = document.createElement('div'); transcript.className = 'msg-content'; transcript.style.opacity = '0.85';
  transcript.textContent = msg.transcript ? `STTï¼š${msg.transcript}` : '';
  const bar = document.createElement('div'); bar.className = 'reaction-bar';
  REACTIONS.forEach(em => {
    const b = document.createElement('button'); b.className = 'reaction-btn'; b.textContent = em;
    b.onclick = () => sendReaction(li.dataset.id, em);
    bar.appendChild(b);
  });
  body.appendChild(header); body.appendChild(audio); if (msg.transcript) body.appendChild(transcript); body.appendChild(bar);
  li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function renderReaction(messageId, emoji) {
  // æ‰¾åˆ°è¨Šæ¯å…ƒç´ 
  const target = Array.from(messagesEl.children).find(li => li.dataset.id === messageId);
  if (!target) return;
  // æ¼‚æµ®å‹•ç•«
  const flo = document.createElement('div'); flo.className = 'reaction-float'; flo.textContent = emoji;
  flo.style.left = '60px'; flo.style.top = '10px';
  target.appendChild(flo); setTimeout(() => flo.remove(), 1400);
}

// ç³»çµ±è¨Šæ¯
function addSystemMessage(text) {
  const li = document.createElement('li'); li.className = 'message';
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header'; header.textContent = 'ç³»çµ±';
  const content = document.createElement('div'); content.className = 'msg-content'; content.textContent = text;
  body.appendChild(header); body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// å·¥å…·
function normalize(s) { return (s || '').toString().trim().toLowerCase(); }

// åœ–ç‰‡æ”¾å¤§
function showModal(src) { $('modalImg').src = src; $('imgModal').style.display = 'flex'; }
function hideModal() { $('imgModal').style.display = 'none'; $('modalImg').src = ''; }
</script>
</body>
</html>